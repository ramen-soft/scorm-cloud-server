var API={};var SCORM_context=null;var SCORM_error_code=0;var SCORM_error_text="";API.registerSCORMcontext=function(referer,callback){SCORM_context=referer;id_content=referer.options.screen_manager.element.attr("id").replace("screen_","");TRACKING_MANAGER("scormGetAllValues",function(result){for(var x in result){switch(x){case "cmi.core._children":TRACKING_MANAGER("setValue","contents.{this_content}.data.core_children",result[x],SCORM_context);break;case "cmi.core.credit":TRACKING_MANAGER("setValue","contents.{this_content}.data.credit",result[x],SCORM_context);break;case "cmi.core.entry":TRACKING_MANAGER("setValue","contents.{this_content}.data.entry",result[x],SCORM_context);break;case "cmi.core.launch_data":TRACKING_MANAGER("setValue","contents.{this_content}.data.launch_data",result[x],SCORM_context);break;case "cmi.core.lesson_mode":TRACKING_MANAGER("setValue","contents.{this_content}.data.lesson_mode",result[x],SCORM_context);break;case "cmi.core.comments_from_lms":TRACKING_MANAGER("setValue","contents.{this_content}.data.comments_from_lms",result[x],SCORM_context);break;case "cmi.core.lesson_status":TRACKING_MANAGER("setValue","contents.{this_content}.status",result[x],SCORM_context);if(result[x]!="completed"&&result[x]!="passed"&&result[x]!="failed"){TRACKING_MANAGER("setValue","contents.{this_content}.progress",0,SCORM_context)}
break;case "cmi.core.lesson_location":TRACKING_MANAGER("setValue","contents.{this_content}.last_location",result[x],SCORM_context);break;case "cmi.core.score._children":TRACKING_MANAGER("setValue","contents.{this_content}.data.score__children",result[x],SCORM_context);break;case "cmi.core.score.raw":if(result.x!=""){TRACKING_MANAGER("setValue","contents.{this_content}.score",result[x],SCORM_context)}else{TRACKING_MANAGER("setValue","contents.{this_content}.score",null,SCORM_context)}
break;case "cmi.core.score.min":if(result.x!=""){TRACKING_MANAGER("setValue","contents.{this_content}.data.score_min",result[x],SCORM_context)}else{TRACKING_MANAGER("setValue","contents.{this_content}.data.score_min",null,SCORM_context)}
break;case "cmi.core.score.max":if(result.x!=""){TRACKING_MANAGER("setValue","contents.{this_content}.data.score_max",result[x],SCORM_context)}else{TRACKING_MANAGER("setValue","contents.{this_content}.data.score_max",null,SCORM_context)}
break;case "cmi.core.total_time":TRACKING_MANAGER("setValue","contents.{this_content}.elapsed_time",ENGINE("utils","stringToSeconds",result[x]),SCORM_context);break;case "cmi.comments":TRACKING_MANAGER("setValue","contents.{this_content}.data.comments",result[x],SCORM_context);break;case "cmi.suspend_data":if(result[x].trim()==""){TRACKING_MANAGER("setValue","contents.{this_content}.data.suspend_data",result[x],SCORM_context)}
break;default:if(x=="cmi.objectives._count"){if(result[x]==0){var current_value=TRACKING_MANAGER("getValue","contents.{this_content}.data."+ENGINE("utils","replace",x,".","_"),SCORM_context);for(var i=0;i<current_value;i++){TRACKING_MANAGER("deleteValue","contents.{this_content}.data.cmi_objectives_"+i+"_id",SCORM_context);TRACKING_MANAGER("deleteValue","contents.{this_content}.data.cmi_objectives_"+i+"_status",SCORM_context);TRACKING_MANAGER("deleteValue","contents.{this_content}.data.cmi_objectives_"+i+"_score_raw",SCORM_context);TRACKING_MANAGER("deleteValue","contents.{this_content}.data.cmi_objectives_"+i+"_score_min",SCORM_context);TRACKING_MANAGER("deleteValue","contents.{this_content}.data.cmi_objectives_"+i+"_score_max",SCORM_context)}}}else if(x=="cmi.interactions._count"){if(result[x]==0){var current_value=TRACKING_MANAGER("getValue","contents.{this_content}.data."+ENGINE("utils","replace",x,".","_"),SCORM_context);for(var i=0;i<current_value;i++){TRACKING_MANAGER("deleteValue","contents.{this_content}.data.cmi_interactions_"+i+"_id",SCORM_context);TRACKING_MANAGER("deleteValue","contents.{this_content}.data.cmi_interactions_"+i+"_time",SCORM_context);TRACKING_MANAGER("deleteValue","contents.{this_content}.data.cmi_interactions_"+i+"_type",SCORM_context);TRACKING_MANAGER("deleteValue","contents.{this_content}.data.cmi_interactions_"+i+"_weighting",SCORM_context);TRACKING_MANAGER("deleteValue","contents.{this_content}.data.cmi_interactions_"+i+"_student_response",SCORM_context);TRACKING_MANAGER("deleteValue","contents.{this_content}.data.cmi_interactions_"+i+"_result",SCORM_context);TRACKING_MANAGER("deleteValue","contents.{this_content}.data.cmi_interactions_"+i+"_latency",SCORM_context);var current_value2=TRACKING_MANAGER("getValue","contents.{this_content}.data.cmi_interactions_"+i+"_objectives__count",SCORM_context);for(var j=0;j<current_value2;j++){TRACKING_MANAGER("deleteValue","contents.{this_content}.data.cmi_interactions_"+i+"_objectives_"+j+"_id",SCORM_context)}
var current_value3=TRACKING_MANAGER("getValue","contents.{this_content}.data.cmi_interactions_"+i+"_correct_responses__count",SCORM_context);for(var k=0;k<current_value3;k++){TRACKING_MANAGER("deleteValue","contents.{this_content}.data.cmi_interactions_"+i+"_correct_responses_"+k+"_pattern",SCORM_context)}}}}
if(x.substr(x.length-6)=="_count"){TRACKING_MANAGER("setValue","contents.{this_content}.data."+ENGINE("utils","replace",x,".","_"),parseInt(result[x],10),SCORM_context)}else{TRACKING_MANAGER("setValue","contents.{this_content}.data."+ENGINE("utils","replace",x,".","_"),result[x],SCORM_context)}
break}}
TRACKING_MANAGER("commitChanges");callback()})}
API.LMSGetValue=function(v){var result;switch(v){case "cmi.core.student_id":result=ENGINE("vars","engine.user_name")+"@"+ENGINE("vars","engine.user_customer");return result;break;case "cmi.core.student_name":result=ENGINE("vars","engine.user_fullname");return result;break;case "cmi.core._children":result=TRACKING_MANAGER("getValue","contents.{this_content}.data.core_children",SCORM_context);if(result=="null"||result==null||result==undefined||result=="undefined"){result=""}
return result;break;case "cmi.core.credit":result=TRACKING_MANAGER("getValue","contents.{this_content}.data.credit",SCORM_context);if(result=="null"||result==null||result==undefined||result=="undefined"){result=""}
return result;break;case "cmi.core.entry":result=TRACKING_MANAGER("getValue","contents.{this_content}.data.entry",SCORM_context);if(result=="null"||result==null||result==undefined||result=="undefined"){result=""}
return result;break;case "cmi.core.launch_data":result=TRACKING_MANAGER("getValue","contents.{this_content}.data.launch_data",SCORM_context);if(result=="null"||result==null||result==undefined||result=="undefined"){result=""}
return result;break;case "cmi.core.lesson_mode":result=TRACKING_MANAGER("getValue","contents.{this_content}.data.lesson_mode",SCORM_context);if(result=="null"||result==null||result==undefined||result=="undefined"){result=""}
return result;break;case "cmi.core.comments_from_lms":result=TRACKING_MANAGER("getValue","contents.{this_content}.data.comments_from_lms",SCORM_context);if(result=="null"||result==null||result==undefined||result=="undefined"){result=""}
return result;break;case "cmi.core.lesson_status":result=TRACKING_MANAGER("getValue","contents.{this_content}.status",SCORM_context);ENGINE("console","LMSGetValue "+v+" >> "+result,null,"CRITICAL");if(result==null||result=="null"||result=="not attempted"){TRACKING_MANAGER("setValue","contents.{this_content}.status","incomplete",SCORM_context);TRACKING_MANAGER("scormSetValue",v,"incomplete");return"not attempted"}else{return result}
break;case "cmi.core.lesson_location":result=TRACKING_MANAGER("getValue","contents.{this_content}.last_location",SCORM_context);if(result=="null"||result==null||result==undefined||result=="undefined"){result=""}
return result;break;case "cmi.core.score._children":result=TRACKING_MANAGER("getValue","contents.{this_content}.data.score__children",SCORM_context);if(result=="null"||result==null||result==undefined||result=="undefined"){result=""}
return result;break;case "cmi.core.score.raw":result=TRACKING_MANAGER("getValue","contents.{this_content}.score",SCORM_context);if(result=="null"||result==null||result==undefined||result=="undefined"){result=""}
ENGINE("console","LMSGetValue "+v+" >> "+result,null,"CRITICAL");return result;break;case "cmi.core.score.min":result=TRACKING_MANAGER("getValue","contents.{this_content}.data.score_min",SCORM_context);if(result=="null"||result==null||result==undefined||result=="undefined"){result=""}
return result;break;case "cmi.core.score.max":result=TRACKING_MANAGER("getValue","contents.{this_content}.data.score_max",SCORM_context);if(result=="null"||result==null||result==undefined||result=="undefined"){result=""}
return result;break;case "cmi.core.total_time":result=ENGINE("utils","secondsToString",TRACKING_MANAGER("getValue","contents.{this_content}.elapsed_time",SCORM_context));ENGINE("console","LMSGetValue "+v+" >> "+result,null,"CRITICAL");return result;break;case "cmi.comments":result=TRACKING_MANAGER("getValue","contents.{this_content}.data.comments",SCORM_context);if(result=="null"||result==null||result==undefined||result=="undefined"){result=""}
return result;break;case "cmi.suspend_data":result=TRACKING_MANAGER("getValue","contents.{this_content}.data.suspend_data",SCORM_context);if(result=="null"||result==null||result==undefined||result=="undefined"){result=""}
return result;break;default:if(v.substr(0,14)=="cmi.objectives"){result=TRACKING_MANAGER("getValue","contents.{this_content}.data."+ENGINE("utils","replace",v,".","_"),SCORM_context);if(v=="cmi.objectives._count"){if(result=="null"||result==null||result==undefined||result=="undefined"){result=0}}}else if(v.substr(0,16)=="cmi.interactions"){if(v.substr(v.length-9)=="_children"||v.substr(v.length-6)=="_count"){result=TRACKING_MANAGER("getValue","contents.{this_content}.data."+ENGINE("utils","replace",v,".","_"),SCORM_context);if(v.substr(v.length-6)=="_count"){if(result=="null"||result==null||result==undefined||result=="undefined"){result=0}}}else{result=""}}else if(v.substr(0,16)=="cmi.student_data"){result=TRACKING_MANAGER("getValue","contents.{this_content}.data."+ENGINE("utils","replace",v,".","_"),SCORM_context);if(result=="null"||result==null||result==undefined||result=="undefined"){result=""}}else if(v.substr(0,22)=="cmi.student_preference"){result=TRACKING_MANAGER("getValue","contents.{this_content}.data."+ENGINE("utils","replace",v,".","_"),SCORM_context);if(result=="null"||result==null||result==undefined||result=="undefined"){result=""}}else{result=""}
return result;break}};API.LMSSetValue=function(n,v){TRACKING_MANAGER("scormSetValue",n,v);switch(n){case "cmi.core.lesson_status":if(v!="completed"&&v!="incomplete"&&v!="passed"&&v!="failed"&&v!="browsed"){v="incomplete"}
if(v=="completed"||v=="passed"||v=="failed"){TRACKING_MANAGER("setValue","contents.{this_content}.progress","100",SCORM_context)}
TRACKING_MANAGER("setValue","contents.{this_content}.status",v,SCORM_context);TRACKING_MANAGER("commitChanges");break;case "cmi.core.lesson_location":TRACKING_MANAGER("setValue","contents.{this_content}.last_location",v,SCORM_context);break;case "cmi.core.exit":TRACKING_MANAGER("setValue","contents.{this_content}.data.exit",v,SCORM_context);break;case "cmi.core.score.raw":TRACKING_MANAGER("setValue","contents.{this_content}.score",v,SCORM_context);TRACKING_MANAGER("commitChanges");break;case "cmi.core.score.min":TRACKING_MANAGER("setValue","contents.{this_content}.data.score_min",v,SCORM_context);break;case "cmi.core.score.max":TRACKING_MANAGER("setValue","contents.{this_content}.data.score_max",v,SCORM_context);break;case "cmi.core.session_time":TRACKING_MANAGER("setValue","contents.{this_content}.session_time",ENGINE("utils","stringToSeconds",v),SCORM_context);break;case "cmi.comments":TRACKING_MANAGER("setValue","contents.{this_content}.data.comments",v,SCORM_context);break;case "cmi.suspend_data":TRACKING_MANAGER("setValue","contents.{this_content}.data.suspend_data",v,SCORM_context);break;default:if(n.substr(0,14)=="cmi.objectives"){TRACKING_MANAGER("setValue","contents.{this_content}.data."+ENGINE("utils","replace",n,".","_"),v,SCORM_context);if(n.substr(n.length-3)==".id"){TRACKING_MANAGER("setValueFx","contents.{this_content}.data.cmi_objectives__count","++",[],SCORM_context)}}else if(n.substr(0,16)=="cmi.interactions"){TRACKING_MANAGER("setValue","contents.{this_content}.data."+ENGINE("utils","replace",n,".","_"),v,SCORM_context);if(n.substr(n.length-3)==".id"){if(n.indexOf("objectives")>0){var n_array=n.split(".");TRACKING_MANAGER("setValueFx","contents.{this_content}.data.cmi_interactions_"+n_array[2]+"_objectives__count","++",[],SCORM_context)}else if(n.indexOf("correct_responses")>0){var n_array=n.split(".");TRACKING_MANAGER("setValueFx","contents.{this_content}.data.cmi_interactions_"+n_array[2]+"_correct_responses__count","++",[],SCORM_context)}else{TRACKING_MANAGER("setValueFx","contents.{this_content}.data.cmi_interactions__count","++",[],SCORM_context)}}}else if(n.substr(0,22)=="cmi.student_preference"){TRACKING_MANAGER("setValue","contents.{this_content}.data."+ENGINE("utils","replace",n,".","_"),v,SCORM_context)}
break}
return"true"};API.LMSInitialize=function(){if(SCORM_context!=null){return"true"}else{SCORM_error_code=302;SCORM_error_text="Contexto no inicializado";return"false"}};API.LMSCommit=function(){TRACKING_MANAGER("commitChanges");ENGINE("console","LMSCommit",null,"CRITICAL");TRACKING_MANAGER("scormCommit");return""};API.LMSFinish=function(){ENGINE("console","LMSFinish",null,"CRITICAL");TRACKING_MANAGER("scormCommit");TRACKING_MANAGER("scormFinish");return""};API.LMSGetLastError=function(){return SCORM_error_code};API.LMSGetErrorString=function(){return SCORM_error_text};API.LMSGetDiagnostic=function(){return SCORM_error_text};$.widget("ui.tracking_manager",{options:{params:'',usertracking:'',indicators:'',listeners:'',element:'',screen_manager:'',prod_id:'',cont_id:'',scorm:'no',proxy:'',rpc:null,active:!0,enabled:!0,params_xml:'',usertracking_xml:'',indicators_xml:'',listeners_xml:'',listeners_array:'',listeners_array2:'',timer:'',timer_count:0,session_time:0,screen_times:'',params_array:'',usertracking_array:'',queue_array:'',status:'busy'},_create:function(){var _this=this;this.options.element=this.element;this.options.screen_manager="ROOT";if(this.options.usertracking==""){this.options.active=!1}else{var k="";var c="";for(i=0;i<xxx.length;i++){k+=String.fromCharCode(Number(xxx[4])^xxx.charCodeAt(i))}
c=Cry.charenc.Binary.stringToBytes(k.substr(Number(xxx[4]),Number(xxx.substr(3,2))));if($.browser.msie&&parseInt($.browser.version,10)<9){this.options.params=Base64.decode(this.options.params);this.options.usertracking=Base64.decode(this.options.usertracking);this.options.indicators=Base64.decode(this.options.indicators);this.options.listeners=Base64.decode(this.options.listeners)}else{this.options.params=Cry.Ae.dc(this.options.params,c,{iv:c,mode:new Cry.mode.CBC(Cry.pad.ZeroPadding)});this.options.usertracking=Cry.Ae.dc(this.options.usertracking,c,{iv:c,mode:new Cry.mode.CBC(Cry.pad.ZeroPadding)});this.options.indicators=Cry.Ae.dc(this.options.indicators,c,{iv:c,mode:new Cry.mode.CBC(Cry.pad.ZeroPadding)});this.options.listeners=Cry.Ae.dc(this.options.listeners,c,{iv:c,mode:new Cry.mode.CBC(Cry.pad.ZeroPadding)})}
k="";c="";this.options.params=this.options.params.replace(/\0/g,"");this.options.params=this.options.params.replace(/\\'/g,"'");this.options.usertracking=this.options.usertracking.replace(/\0/g,"");this.options.usertracking=this.options.usertracking.replace(/\\'/g,"'");this.options.indicators=this.options.indicators.replace(/\0/g,"");this.options.indicators=this.options.indicators.replace(/\\'/g,"'");this.options.listeners=this.options.listeners.replace(/\0/g,"");this.options.listeners=this.options.listeners.replace(/\\'/g,"'");var params_doc=$.parseXML(this.options.params);this.options.params_xml=$(params_doc);var usertracking_doc=$.parseXML(this.options.usertracking);this.options.usertracking_xml=$(usertracking_doc);var indicators_doc=$.parseXML(this.options.indicators);this.options.indicators_xml=$(indicators_doc);var listeners_doc=$.parseXML(this.options.listeners);this.options.listeners_xml=$(listeners_doc);if(this.options.scorm=="yes"){this.options.rpc=new easyXDM.Rpc({remote:_this.options.proxy},{remote:{scormSetValue:{},scormGetValue:{},scormGetAllValues:{},scormCommit:{},scormFinish:{}}})}
this.options.params_array=new Object();this.options.usertracking_array=new Object();this.options.queue_array=new Object();this.options.screen_times=new Object();this.options.params_xml.children("params").children().each(function(){_this.options.params_array[$(this).prop("tagName")]=_this._parseValue($(this).text(),$(this).attr("type"))});var target="";var id="";var fields=new Object();target="user";id="void";this.options.usertracking_array[target]=new Object();this.options.usertracking_array[target][id]=new Object();this.options.usertracking_xml.children("usertracking").children("user").children().each(function(index){var field=$(this).prop("nodeName");var type=$(this).attr("type");var value=$(this).text();if(field=="data"){_this.options.usertracking_array[target][id][field]=new Object();$(this).children().each(function(index){var data_field=$(this).prop("nodeName");var data_type=$(this).attr("type");var data_value='';$(this).children().each(function(){data_value+=ENGINE("utils","serializeXML",$(this),!1)});_this.options.usertracking_array[target][id][field][data_field]=_this._parseValue(data_value,data_type)})}else{_this.options.usertracking_array[target][id][field]=_this._parseValue(value,type)}});target="product";id="void";this.options.usertracking_array[target]=new Object();this.options.usertracking_array[target][id]=new Object();this.options.usertracking_xml.children("usertracking").children("product").children().each(function(index){var field=$(this).prop("nodeName");var type=$(this).attr("type");var value=$(this).text();if(field=="data"){_this.options.usertracking_array[target][id][field]=new Object();$(this).children().each(function(index){var data_field=$(this).prop("nodeName");var data_type=$(this).attr("type");var data_value='';$(this).children().each(function(){data_value+=ENGINE("utils","serializeXML",$(this),!1)});_this.options.usertracking_array[target][id][field][data_field]=_this._parseValue(data_value,data_type)})}else{_this.options.usertracking_array[target][id][field]=_this._parseValue(value,type)}});target="contents";this.options.usertracking_array[target]=new Object();this.options.usertracking_xml.children("usertracking").children("contents").children().each(function(index){id=$(this).attr("id");_this.options.usertracking_array[target][id]=new Object();$(this).children().each(function(index){var field=$(this).prop("nodeName");var type=$(this).attr("type");var value=$(this).text();if(field=="data"){_this.options.usertracking_array[target][id][field]=new Object();$(this).children().each(function(index){var data_field=$(this).prop("nodeName");var data_type=$(this).attr("type");var data_value='';if($(this).children().length>0){$(this).children().each(function(){data_value+=ENGINE("utils","serializeXML",$(this),!1)})}else{data_value=$(this).text()}
_this.options.usertracking_array[target][id][field][data_field]=_this._parseValue(data_value,data_type)})}else{_this.options.usertracking_array[target][id][field]=_this._parseValue(value,type)}})});if(this.options.scorm=="yes"){this.setValueFx("user.session_time","+=",[5]);this.setValueFx("product.session_time","+=",[5]);this.setValueFx("user.elapsed_time","+=",[5]);this.setValueFx("product.elapsed_time","+=",[5])}
this.options.timer=setInterval(function(){_this._tick()},1000);this._registerListeners();$(window).unload(function(){_this.commitChanges()})}
this.options.status="ready";ENGINE("event","throw","ready","",this)},_dispatchEvents:function(data,info,context){var _this=context;var source_context=info.context;var source_id=info.source;var source_event=info.event;var source_class=info._class;var source_reference=info.source_reference;var code="";var code_executed=!1;if(context.options.listeners_array[source_id]!=undefined){if(context.options.listeners_array[source_id][source_context]!=undefined){if(typeof context.options.listeners_array[source_id][source_context][source_event]=="function"){try
{context.options.listeners_array[source_id][source_context][source_event](data,info,context)}catch(err){var extra_info={component:'tracking_manager',method:'dispatchEvents',action:'dispatching event',source_id:source_id,source_context:source_context,source_event:source_event,data:data};ENGINE("reportError",err,extra_info,_this)}}}}else if(context.options.listeners_array2[source_context]!=undefined){if(typeof context.options.listeners_array2[source_context][source_event]=="function"){try
{context.options.listeners_array2[source_context][source_event](data,info,context)}catch(err){var extra_info={component:'tracking_manager',method:'dispatchEvents',action:'dispatching generic event',source_id:source_id,source_context:source_context,source_event:source_event,data:data};ENGINE("reportError",err,extra_info,_this)}}}},_emptyUpdates:function(){var _this=this;this.options.queue_array=new Object()},_parseValue:function(value,type){switch(type){case "string":case "varchar":return value;break;case "number":if(isNaN(value)||value=="")
return null;else return Number(value);break;case "bigint":case "int":case "tinyint":if(isNaN(value)||value=="")
return null;else return+value;break;case "float":if(isNaN(value)||value=="")
return null;else return parseFloat(value);break;case "boolean":return parseBoolean(value);break;case "status":if(value==undefined||value=="")
return"not attempted";else return value;break;default:return value;break}},_processQueue:function(){var queue_array=this.options.queue_array;var queue_xml='<updates>';for(var target in queue_array){for(var id in queue_array[target]){queue_xml+='<update target="'+target+'" id="'+id+'">';for(var field in queue_array[target][id]){if(field=="data"){queue_xml+='<data>';for(var data_field in queue_array[target][id][field]){var data_type=isNaN(queue_array[target][id][field][data_field])?"string":"number";queue_xml+='<'+data_field+' type="'+data_type+'">'+queue_array[target][id][field][data_field]+'</'+data_field+'>'}
queue_xml+='</data>'}else{queue_xml+='<'+field+'>'+queue_array[target][id][field]+'</'+field+'>'}}
queue_xml+='</update>'}}
queue_xml+='</updates>';return queue_xml},_registerListeners:function(){var _this=this;this.options.listeners_array=new Array();this.options.listeners_array2=new Array();this.options.listeners_xml.children("listeners").children("listener").each(function(index){var target=$(this).attr("target").toString();var context=$(this).attr("context")==""?"ROOT":$(this).attr("context").toString();var event=$(this).attr("event").toString();var code="";if(context!=""&&event!=""&&$(this).text()!=""){if(target!=""){if(_this.options.listeners_array[target]==null)_this.options.listeners_array[target]=new Array();if(_this.options.listeners_array[target][context]==null)_this.options.listeners_array[target][context]=new Array();code=$.trim($(this).text());if(code!=""&&code!="undefined"&&code!=undefined){code=code.replace(/\u0024\u0028this\u0029/g,"ThIs");code=code.replace(/this/g,"_this");code=code.replace(/ThIs/g,"$(this)");code=code.replace(/{_this_/g,"{this_");code='var _this = context; var source_context = info.context; var source_id = info.source; var source_event = info.event; var source_class = info._class; var source_reference = info.source_reference;'+code;_this.options.listeners_array[target][context][event]=new Function("data","info","context",code)}}else{if(_this.options.listeners_array2[context]==null)_this.options.listeners_array2[context]=new Array();code=$.trim($(this).text());if(code!=""&&code!="undefined"&&code!=undefined){code=code.replace(/\u0024\u0028this\u0029/g,"ThIs");code=code.replace(/this/g,"_this");code=code.replace(/ThIs/g,"$(this)");code=code.replace(/{_this_/g,"{this_");code='var _this = context; var source_context = info.context; var source_id = info.source; var source_event = info.event; var source_class = info._class; var source_reference = info.source_reference;'+code;_this.options.listeners_array2[context][event]=new Function("data","info","context",code)}}
ENGINE("event","listen",target,context,event,_this._dispatchEvents,_this)}})},_tick:function(){if(this.options.active){this.options.timer_count++;this.options.session_time++;if(this.options.timer_count%5==0){this.setValueFx("user.session_time","+=",[5]);this.setValueFx("product.session_time","+=",[5]);this.setValueFx("user.elapsed_time","+=",[5]);this.setValueFx("product.elapsed_time","+=",[5]);for(var screen_id in this.options.screen_times){if(this.options.screen_times[screen_id]){this.setValueFx("contents."+screen_id+".session_time","+=",[5]);this.setValueFx("contents."+screen_id+".elapsed_time","+=",[5])}}
if(this.options.scorm=="yes"){var session_time="00"+ENGINE("utils","secondsToString",parseInt(this.getValue("contents."+this.options.cont_id+".session_time"),10))+".00";this.scormSetValue("cmi.core.session_time",session_time)}
if(this.options.timer_count>=15){this.options.timer_count=0;this.commitChanges()}}}},_updateQueue:function(target,id,field){var _this=this;if(this.options.status=="ready"){this.options.status="busy";if(id=="")id="void";if(this.options.queue_array[target]==null)this.options.queue_array[target]=new Object();if(this.options.queue_array[target][id]==null)this.options.queue_array[target][id]=new Object();if(field=="data"){this.options.queue_array[target][id][field]=new Object();for(var data_field in this.options.usertracking_array[target][id][field]){this.options.queue_array[target][id][field][data_field]=this.options.usertracking_array[target][id][field][data_field]}}else{this.options.queue_array[target][id][field]=this.options.usertracking_array[target][id][field]}
this.options.status="ready"}else{setTimeout(function(){_this._updateQueue(target,id,field)},10)}},activate:function(){},deactivate:function(){},commitChanges:function(callback,retries){var _this=this;if(_this.options.scorm=="yes"){ENGINE("console","******** scormCommit ********",this,"CRITICAL");_this.scormCommit()}
if(this.options.status=="ready"){this.options.status="busy";var queue=_this._processQueue();if(queue!="<updates></updates>"){if(ENGINE("vars","engine.engine_mode")!="stand-alone"){$.post("index.php",{module:'tracking',action:'updateTracking',prod_id:_this.options.prod_id,queue:queue},function(data,textStatus){if(data=="ERROR"||textStatus!="success"){_this.options.status="ready";if(retries=="undefined"||retries==undefined){ENGINE("block",!0,!1);setTimeout(function(){_this.commitChanges(callback,1)},1000)}else{if(retries>=3){ENGINE("unblock");ENGINE("alert","Parece que tu conexión de Internet está fallando y no se han podido guardar los datos de tu progreso...<br/><br/>Por favor, comprueba tu conexión y asegúrate de que sea estable para poder continuar, o de lo contrario podrías perder tus progresos.<br/><br/>Pulsa 'Aceptar' para volver a probar tu conexión...","ERROR DE CONEXIÓN",function(){_this.commitChanges(callback)})}else{setTimeout(function(){_this.commitChanges(callback,retries+1)},1000)}}}else{if(data!=""){_this._emptyUpdates();ENGINE("unblock");_this.options.status="ready";_this.commitRetreivedChanges(data)}else{_this._emptyUpdates();ENGINE("unblock");_this.options.status="ready"}
if(typeof callback=="function"){callback()}}}).fail(function(){_this.options.status="ready";if(retries=="undefined"||retries==undefined){ENGINE("block",!0,!1);setTimeout(function(){_this.commitChanges(callback,1)},1000)}else{if(retries>=3){ENGINE("unblock");ENGINE("alert","Parece que tu conexión de Internet está fallando y no se han podido guardar los datos de tu progreso...<br/><br/>Por favor, comprueba tu conexión y asegúrate de que sea estable para poder continuar, o de lo contrario podrías perder tus progresos.<br/><br/>Pulsa 'Aceptar' para volver a probar tu conexión...","ERROR DE CONEXIÓN",function(){_this.commitChanges(callback)})}else{setTimeout(function(){_this.commitChanges(callback,retries+1)},1000)}}})}else{ENGINE("unblock");this.options.status="ready"}}else{ENGINE("unblock");this.options.status="ready"}}else{setTimeout(function(){_this.commitChanges(callback)},100)}},commitPendingChanges:function(queue,callback){if(this.options.active){var _this=this;if(ENGINE("vars","engine.engine_mode")!="stand-alone"){$.post("index.php",{module:'tracking',action:'updateTracking',prod_id:_this.options.prod_id,queue:queue},function(data,textStatus){if(data=="ERROR"||textStatus!="success"){setTimeout(function(){_this.commitPendingChanges(queue)},30000)}else{if(data!="OK"){_this.commitRetreivedChanges(data)}
if(typeof callback=="function"){callback()}}})}}},commitRetreivedChanges:function(data){var _this=this;var data_doc=$.parseXML(data);var data_xml=$(data_doc);data_xml.children("updates").children("update").each(function(){var target=$(this).attr("target");if(target=="user"||target=="product"){$(this).children().each(function(){_this.setValue(target+"."+$(this).prop("tagName"),$(this).text(),_this,!1)})}
if(target=="contents"){var id_content=$(this).attr("id");$(this).children().each(function(){_this.setValue(target+"."+id_content+"."+$(this).prop("tagName"),$(this).text(),_this,!1)})}});var acum_duration=0;var notifications=[];data_xml.children("updates").children("notifications").children("notification").each(function(){var message=$(this).html();message=message.replace("<![CDATA[","").replace("]]>","");var message2=ENGINE("utils","removeHTMLTags",message);var message_duration=message2.length*70;notifications.push({message:message,duration:message_duration})});for(var i in notifications){ENGINE("message",notifications[i].message,2000+notifications[i].duration,"fa-bullhorn",acum_duration+500);acum_duration+=(2000+notifications[i].duration)}},deleteValue:function(reference,referrer){if(this.options.active){var _this=this;var reference_array=reference.split(".");var target=reference_array[0];var id;var field;var data_field;var ignore=!1;switch(target){case "user":case "product":id="void";field=reference_array[1];if(field=="data"){data_field=reference_array[2];this.options.usertracking_array[target][id][field][data_field]=""}else{this.options.usertracking_array[target][id][field]=""}
this._updateQueue(target,id,field);break;case "contents":id=reference_array[1];field=reference_array[2];if($.trim(id)=="{this_content}"){id=referrer.options.screen_manager.element.attr("id").replace("screen_","")}
if(field=="data"){data_field=reference_array[3];this.options.usertracking_array[target][id][field][data_field]=""}else{this.options.usertracking_array[target][id][field]=""}
this._updateQueue(target,id,field);break}}},disable:function(){this.options.enabled=!1},enable:function(){this.options.enabled=!0},getIndicators:function(domain){return this.options.indicators_xml.children("indicators").children(domain)},getLastLocation:function(instance_id){if(this.options.active){var last_location=this.getValue("product.last_location");var last_location_array=last_location.split("|");var result="";for(var i=0;i<last_location_array.length;i++){if(last_location_array[i]!=""){var info=last_location_array[i].split("=");var id=info[0];var value=info[1];if(instance_id==id)
result=value}}
return result}else return""},getValue:function(reference,referrer){if(this.options.active){var _this=this;var reference_array=reference.split(".");var target=reference_array[0];var id;var field;var data_field;switch(target){case "user":case "product":id="void";field=reference_array[1];if(field=="data"){data_field=reference_array[2];if(this.options.usertracking_array[target][id][field][data_field]==undefined)
return null;else return this.options.usertracking_array[target][id][field][data_field]}else{return this.options.usertracking_array[target][id][field]}
break;case "otherproducts":return"NOT AVAILABLE";break;case "contents":id=reference_array[1];field=reference_array[2];if(id=="{this_content}"){id=referrer.options.screen_manager.element.attr("id").replace("screen_","")}
if(this.options.usertracking_array[target][id]==null){switch(field){case "first_access":case "last_access":case "data":case "retries_left":case "score":return null;break;case "visits":case "elapsed_time":case "session_time":case "credits":case "attempts":case "progress":return 0;break;case "evaluate":case "last_location":case "last_location_str":return"";break;case "status":return"not attempted";break}}
if(field=="data"){data_field=reference_array[3];if(this.options.usertracking_array[target][id][field][data_field]==undefined)
return null;else return this.options.usertracking_array[target][id][field][data_field]}else{return this.options.usertracking_array[target][id][field]}
break;default:ENGINE("console","TRACKING_MANAGER::getValue ERROR\n\nNo existe la variable "+reference+".",this,"WARNING")}}else return null},getValueFx:function(reference,fx,filters,parameters_array){if(this.options.active){var reference_array=reference.split(".");var object=reference_array[0];var field=(reference_array.length>0)?reference_array[1]:"";if(object!="contents"&&context!="otherproducts"){ENGINE("console","TRACKING_MANAGER::getValueFx ERROR\n\nS\u00F3lo es posible ejecutar esta funci\u00F3n sobre los objetos 'otherproducts' y 'contents'.",this,"WARNING");return null}
switch(fx){case "count":var count=0;var test=!1;var fields=new Object();for(var object_id in this.options.usertracking_array[object]){if(filters==""){test=!0}else{test=!1;fields=new Object();for(var object_field in this.options.usertracking_array[object][object_id]){fields[object_field]=this.options.usertracking_array[object][object_id][object_field]}
eval('test = '+filters+';')}
if(test)count ++}
return count;break;case "sum":var count=0;var sum=0;var test=!1;var fields=new Object();for(var object_id in this.options.usertracking_array[object]){if(filters==""){test=!0}else{test=!1;fields=new Object();for(var object_field in this.options.usertracking_array[object][object_id]){fields[object_field]=this.options.usertracking_array[object][object_id][object_field]}
eval('test = '+filters+';')}
if(test){count ++;sum+=parseFloat(this.options.usertracking_array[object][object_id][field])}}
if(count>0)
return sum;else return null;break;case "avg":var count=0;var sum=0;var test=!1;var fields=new Object();for(var object_id in this.options.usertracking_array[object]){if(filters==""){test=!0}else{test=!1;fields=new Object();for(var object_field in this.options.usertracking_array[object][object_id]){fields[object_field]=this.options.usertracking_array[object][object_id][object_field]}
eval('test = '+filters+';')}
if(test){count ++;sum+=parseFloat(this.options.usertracking_array[object][object_id][field])}}
if(count>0)
return sum/count;else return null;break;default:alert("TRACKING_MANAGER::getValueFx ERROR\n\nNo existe la funci\u00F3n "+fx+".")}}},reportEvaluationDone:function(correct_count,semicorrect_count,incorrect_count,total_count,score,evaluation_input,referrer){var _this=this;var screen_id=referrer.options.screen_manager.element.attr("id").replace("screen_","");var screen_title=referrer.options.screen_manager.element.attr("contenttitle");if(score>=this.options.params_array.passing_score){this.setValue("contents."+screen_id+".status","passed")}else{this.setValue("contents."+screen_id+".status","failed")}
this.setValue("contents."+screen_id+".progress","100");this.setValueFx("contents."+screen_id+".attempts","++",[]);this.commitChanges();ENGINE("event","throw","evaluation_done",{screen_id:screen_id,input:evaluation_input,correct_count:correct_count,semicorrect_count:semicorrect_count,incorrect_count:incorrect_count,total_count:total_count,score:score},this);if(this.options.scorm=="yes"){}},reportScreenClose:function(screen_viewer_id,screen_id){if(this.options.active){this.options.screen_times[screen_id]=!1;ENGINE("event","throw","screen_close",{viewer:screen_viewer_id,id:screen_id},this);this.commitChanges()}},reportScreenOpen:function(screen_viewer_id,screen_id,screen_name){if(this.options.active){var _this=this;this.options.screen_times[screen_id]=!0;this.setValueFx("contents."+screen_id+".visits","++",[]);this.setValue("contents."+screen_id+".last_access","{currentFullTime}");this.setValue("contents."+screen_id+".session_time",0);ENGINE("event","throw","screen_open",{viewer:screen_viewer_id,id:screen_id,name:screen_name},this);setTimeout(function(){_this.commitChanges()},1000)}},reset:function(){},scormCommit:function(){if(this.options.scorm=="yes"){this.options.rpc.scormCommit(function(result){ENGINE("console","scormCommit =  "+result,null,"CRITICAL")})}},scormFinish:function(){if(this.options.scorm=="yes"){this.options.rpc.scormFinish(function(result){ENGINE("console","scormFinish =  "+result,null,"CRITICAL")})}},scormGetAllValues:function(callback){if(this.options.scorm=="yes"){this.options.rpc.scormGetAllValues(id_content,function(result){callback(result)})}else{var result={};callback(result)}},scormSetValue:function(context,value){var _this=this;if(this.options.scorm=="yes"){this.options.rpc.scormSetValue(context,value,function(result){ENGINE("console","scormSetValue("+context+", "+value+") = "+result,null,"CRITICAL");if(context=="cmi.core.lesson_status"&&value=="completed"){var mastery_score=_this.getValue("contents.{this_content}.data.cmi_student_data_mastery_score",SCORM_context);var score=_this.getValue("contents.{this_content}.score",SCORM_context);if(mastery_score!=""&&mastery_score!=undefined&&mastery_score!=null){if(score!=null&&score!=undefined){if(parseInt(score,10)>=parseInt(mastery_score)){_this.setValue("contents.{this_content}.status","passed",SCORM_context);_this.scormSetValue(context,"passed")}else{_this.setValue("contents.{this_content}.status","failed",SCORM_context);_this.scormSetValue(context,"failed")}}}}else if(context=="cmi.core.score.raw"){var mastery_score=_this.getValue("contents.{this_content}.data.cmi_student_data_mastery_score",SCORM_context);if(mastery_score!=""&&mastery_score!=undefined&&mastery_score!=null){if(parseInt(value,10)>=parseInt(mastery_score)){_this.setValue("contents.{this_content}.status","passed",SCORM_context);_this.scormSetValue("cmi.core.lesson_status","passed")}else{_this.setValue("contents.{this_content}.status","failed",SCORM_context);_this.scormSetValue("cmi.core.lesson_status","failed")}}}})}},setValue:function(reference,new_value,referrer,update_queue){if(this.options.active){ENGINE("console","setValue "+reference+" = "+new_value,null,"CRITICAL");var _this=this;var reference_array=reference.split(".");var target=reference_array[0];var id;var field;var data_field;var ignore=!1;switch(target){case "user":case "product":id="void";field=reference_array[1];if(field=="data"){data_field=reference_array[2];this.options.usertracking_array[target][id][field][data_field]=new_value}else{if(this.options.usertracking_array[target][id][field]!=new_value){this.options.usertracking_array[target][id][field]=new_value}else{ignore=!0}}
if(update_queue!=!1&&!ignore)this._updateQueue(target,id,field);if((field=="progress"||field=="score"||field=="status")&&!ignore){ENGINE("event","throw",field+"_change",{target:target,subtarget:null,status:new_value},this)}
break;case "contents":id=reference_array[1];field=reference_array[2];var commit_changes=!1;if($.trim(id)=="{this_content}"){id=referrer.options.screen_manager.element.attr("id").replace("screen_","")}
if(this.options.usertracking_array[target][id]==null){this.options.usertracking_array[target][id]=new Object();this.options.usertracking_array[target][id].first_access="{currentFullTime}";this.options.usertracking_array[target][id].last_access="{currentFullTime}";this.options.usertracking_array[target][id].visits=0;this.options.usertracking_array[target][id].elapsed_time=0;this.options.usertracking_array[target][id].session_time=0;this.options.usertracking_array[target][id].data=new Object();this.options.usertracking_array[target][id].last_location="";this.options.usertracking_array[target][id].last_location_str="";this.options.usertracking_array[target][id].evaluate="";this.options.usertracking_array[target][id].progress=0;this.options.usertracking_array[target][id].status="not attempted";this.options.usertracking_array[target][id].score=null;this._updateQueue(target,id,"first_access");this._updateQueue(target,id,"last_access");this._updateQueue(target,id,"visits");this._updateQueue(target,id,"elapsed_time");this._updateQueue(target,id,"session_time");this._updateQueue(target,id,"last_location");this._updateQueue(target,id,"last_location_str");this._updateQueue(target,id,"evaluate");this._updateQueue(target,id,"progress");this._updateQueue(target,id,"status");this.options.indicators_xml.children("indicators").children("indicator").each(function(){_this.options.usertracking_array[target][id][$(this).attr("id")]=null;switch($(this).attr("type")){case "varchar":case "text":case "longtext":_this.options.usertracking_array[target][id][$(this).attr("id")]="";break;case "status":_this.options.usertracking_array[target][id][$(this).attr("id")]="not attempted";break}});commit_changes=!0}
if(field=="data"){data_field=reference_array[3];this.options.usertracking_array[target][id][field][data_field]=new_value}else{if(this.options.usertracking_array[target][id][field]!=new_value){this.options.usertracking_array[target][id][field]=new_value}else{ignore=!0}}
if(update_queue!=!1&&!ignore)this._updateQueue(target,id,field);if(commit_changes)this.commitChanges();if((field=="progress"||field=="score"||field=="status")&&!ignore){ENGINE("console","field =  "+field,null,"CRITICAL");this.commitChanges();ENGINE("console","commitChanges",null,"CRITICAL");ENGINE("event","throw",field+"_change",{target:target,subtarget:id,status:new_value},this)}
break;default:alert("TRACKING_MANAGER::setValue ERROR\n\nNo existe la variable "+reference+".")}}},setValueFx:function(reference,fx,parameters_array,referrer){if(this.options.active){switch(fx){case "++":var value=this.getValue(reference,referrer);if(value==null){this.setValue(reference,1,referrer)}else if(typeof value=="string"&&value.indexOf(":")==2&&value.indexOf(":",3)==5&&value.length==8){var new_time=ENGINE("utils","stringToSeconds",value)+1;this.setValue(reference,ENGINE("utils","secondsToString",new_time),referrer)}else if(typeof value=="number"){this.setValue(reference,value+1,referrer)}else alert(value+" | "+typeof value);break;case "--":var value=this.getValue(reference,referrer);if(value==null){this.setValue(reference,-1,referrer)}else if(typeof value=="string"&&value.indexOf(":")==2&&value.indexOf(":",3)==5&&value.length==8){var new_time=ENGINE("utils","stringToSeconds",value)-1;this.setValue(reference,ENGINE("utils","secondsToString",new_time),referrer)}else if(typeof value=="number"){this.setValue(reference,value-1,referrer)}
break;case "+=":var value=this.getValue(reference,referrer);if(value==null){this.setValue(reference,parameters_array[0],referrer)}else if(typeof value=="string"&&value.indexOf(":")==2&&value.indexOf(":",3)==5&&value.length==8){var new_time=ENGINE("utils","stringToSeconds",value)+parameters_array[0];this.setValue(reference,ENGINE("utils","secondsToString",new_time),referrer)}else if(typeof value=="number"||typeof value=="string"){this.setValue(reference,value+parameters_array[0],referrer)}
break;case "-=":var value=this.getValue(reference,referrer);if(value==null){this.setValue(reference,-parameters_array[0],referrer)}else if(typeof value=="string"&&value.indexOf(":")==2&&value.indexOf(":",3)==5&&value.length==8){var new_time=ENGINE("utils","stringToSeconds",value)-parameters_array[0];this.setValue(reference,ENGINE("utils","secondsToString",new_time),referrer)}else if(typeof value=="number"){this.setValue(reference,value-parameters_array[0],referrer)}
break;case "*=":var value=this.getValue(reference,referrer);if(value==null){this.setValue(reference,0,referrer)}
if(typeof value=="number"){this.setValue(reference,value*parameters_array[0],referrer)}
break;default:alert("TRACKING_MANAGER::setValueFx ERROR\n\nNo existe la funci\u00F3n "+fx+".")}}},destroy:function(){this.options.listeners_array=null;this.options.listeners_array2=null;ENGINE("event","throw","destroy","",this);$.Widget.prototype.destroy.apply(this,arguments)}})